!function($){function bind_grant_plugin(obj,settings){if(obj.parent().is("span.inputs_group")){var p=obj.closest(".controls");obj.p=p}else{obj.wrap(settings.wrap_html);var p=obj.parent();obj.p=p}if((settings.pre_lookup||"true"===obj.attr("data-autolookup"))&&_lookup(obj,settings),settings.lookup){var lookup_btn=$("<button>").addClass(settings.lookup_class).html(settings.lookup_text);p.append(lookup_btn),$(lookup_btn).on("click",function(e){e.preventDefault(),_lookup(obj,settings)})}if(settings.search){var funders_list="";if(settings.funder_lists){funders_list='<select name="funders" class="funder"><option value="All">All</option>';var theList=jQuery.parseJSON(settings.funders);for(i=0;i<theList.funder_list.length;i++)funders_list=funders_list+'<option value="'+theList.funder_list[i]+'">'+theList.funder_list[i]+"</option>";funders_list+="</select>"}var search_btn=$("<button>").addClass(settings.search_class).html(settings.search_text),search_html=settings.query_text+' <input type="text" class="grant_search_input"/> '+funders_list+' <a class="search_grant">'+settings.search_text_btn+'</a><div class="grant_search_result"></div><a class="close_search">'+settings.close_search_text_btn+"</a>",search_div=$("<div>").addClass(settings.search_div_class).html(search_html);settings.pre_open_search||$(search_div).hide(),p.append(search_btn).append(search_div),$(search_btn).on("click",function(e){e.preventDefault(),_search_form(obj,settings)}),$("input.grant_search_input",p).on("keypress",function(e){if(13==e.keyCode){if(console.log($(this).next().prop("tagName")),"A"==$(this).next().prop("tagName"))var funder="All";else var funder=$("select.funder").val();return _search($(this).val(),funder,obj,settings),!1}}),$(".search_grant",p).on("click",function(e){e.preventDefault(),e.stopPropagation();var query=$(".grant_search_input",p).val();if(console.log($(this).next().prop("tagName")),"A"==$(this).next().prop("tagName"))var funder="All";else var funder=$("select.funder").val();_search(query,funder,obj,settings)}),$(".close_search",p).on("click",function(){$("."+settings.search_div_class,p).slideUp()})}settings.before_html&&obj.before(settings.before_html),$(obj).on("keypress",function(e){return 13==e.keyCode?(_lookup(obj,settings),!1):void 0})}function _lookup(obj,settings){var value=obj.val().replace("http://","");$.ajax({url:settings.lookup_endpoint+encodeURIComponent(value),dataType:"json",timeout:1e3,success:function(data){if(settings.lookup_success_handler&&"function"==typeof settings.lookup_success_handler)settings.lookup_success_handler(data,obj,settings);else{_clean(obj,settings);var html=_constructGrantHTML(data.message.recordData,settings),result_div=$("<div>").addClass(settings.result_success_class).html(html);obj.p.append(result_div),settings.post_lookup_success_handler&&"function"==typeof settings.post_lookup_success_handler&&settings.post_lookup_success_handler(data,obj,settings)}},error:function(xhr){if(settings.lookup_error_handler&&"function"==typeof settings.lookup_error_handler)settings.lookup_error_handler(xhr);else{_clean(obj,settings);var result_div=$("<div>").addClass(settings.result_error_class).html(settings.nohits_msg);obj.p.append(result_div),obj.addClass("error")}}})}function _constructGrantHTML(obj,settings){var resStr="";if(resStr+="<div class='"+settings.info_box_class+"'>",1==obj.length){if(resStr+="<h4>Grant Information</h4>",obj[0].title){resStr+="<h6>Title</h6>";var title=$("<textarea />").html(obj[0].title).text();title=title.replace(/"/g,"&quot;"),resStr+="<p>"+title+"</p>"}if(obj[0].description){resStr+="<h6>Description</h6>";var description=$("<textarea />").html(obj[0].description).text();description=description.replace(/"/g,"&quot;"),resStr+="<p>"+description+"</p>"}if(obj[0].relations){if(resStr+="<h6>Relationships</h6>","string"==typeof obj[0].relations.isFundedBy)resStr+="<p>Is funded by</p>",resStr+="<p>"+obj[0].relations.isFundedBy+"</p>";else if("array"==typeof obj[0].relations.isFundedBy){for(resStr+="<p>Is funded by</p><p>",i=0;i<obj[0].relations.isFundedBy.length;i++)resStr+=obj[0].relations.isFundedBy[i]+", ";resStr=resStr.replace(/(^\s*,)|(,\s*$)/g,""),resStr+="</p>"}if("string"==typeof obj[0].relations.isManagedBy)resStr+="<p>Is managed by</p>",resStr+="<p>"+obj[0].relations.isManagedBy+"</p>";else if("array"==typeof obj[0].relations.isManagedBy){for(resStr+="<p>Is managed by</p><p>",i=0;i<obj[0].relations.isManagedBy.length;i++)resStr+=obj[0].relations.isManagedBy[i]+", ";resStr=resStr.replace(/(^\s*,)|(,\s*$)/g,""),resStr+="</p>"}if("string"==typeof obj[0].relations.isParticipantIn)resStr+="<p>Has participant</p>",resStr+="<p>"+obj[0].relations.isParticipantIn+"</p>";else if("array"==typeof obj[0].relations.isParticipantIn){for(resStr+="<p>Has participant</p><p>",i=0;i<obj[0].relations.isParticipantIn.length;i++)resStr+=obj[0].relations.isParticipantIn[i]+", ";resStr=resStr.replace(/(^\s*,)|(,\s*$)/g,""),resStr+="</p>"}if("string"==typeof obj[0].relations.isPrincipalInvestigatorOf)resStr+="<p>Has principal investigator</p>",resStr+="<p>"+obj[0].relations.isPrincipalInvestigatorOf+"</p>";else if("array"==typeof obj[0].relations.isPrincipalInvestigatorOf){for(resStr+="<p>Has principal investigator</p><p>",i=0;i<obj[0].relations.isPrincipalInvestigatorOf.length;i++)resStr+=obj[0].relations.isPrincipalInvestigatorOf[i]+", ";resStr=resStr.replace(/(^\s*,)|(,\s*$)/g,""),resStr+="</p>"}}}else resStr+=0==obj.length?"<p>0 results returned. Please supply a valid grant id</p>":"<p>Multiple results returned. Please supply an exact grant id</p>";return resStr+="</div>"}function _search(query,funder,obj,settings){var p=obj.p,funder_list=(p.find("."+settings.grant_search_result),"");"All"!=funder&&(funder_list="&groups="+funder),""==$.trim(query)?$(".grant_search_result",p).html("Please enter a search string"):($(".grant_search_result",p).html("Loading..."),$.ajax({url:settings.search_endpoint+encodeURIComponent(query)+funder_list+"&start=0&rows=10",dataType:"json",success:function(data){if(settings.success_handler&&"function"==typeof settings.success_handler)settings.success_handler(data,obj,settings);else if(data.message.numFound>0){var html="<ul>";$.each(data.message.recordData,function(){var titleStr="",obj=new Array(this);settings.tooltip&&(titleStr='title="'+_constructGrantHTML(obj,settings)+'"'),html+="<li>",html+='<a class="select_grant_search_result preview" grant-id="'+this.key+'" '+titleStr+" >"+this.title+"</a>",html+="</li>"}),html+="</ul>",$(".grant_search_result",p).html(html)}else $(".grant_search_result",p).html(settings.nohits_msg);$(".select_grant_search_result",p).on("click",function(){obj.val($(this).attr("grant-id")),_lookup(obj,settings),settings.auto_close_search&&_search_form(obj,settings)}),settings.tooltip&&$(".preview").each(function(){$(this).qtip({content:{text:$(this).attr("title")},position:{my:"left center",at:"right center",viewport:$(window)},show:{event:"mouseover"},hide:{event:"mouseout"},style:{classes:"ui-tooltip-light ui-tooltip-shadow grantPreview",width:550}})})},error:function(xhr){settings.error_handler&&"function"==typeof settings.error_handler?settings.error_handler(xhr):console.error(xhr)}}))}function _clean(obj,settings){obj.removeClass("error"),obj.p.children("."+settings.result_error_class).length>0&&obj.p.children("."+settings.result_error_class).remove(),obj.p.children("."+settings.result_success_class).length>0&&obj.p.children("."+settings.result_success_class).remove()}function _search_form(obj,settings){obj.p.children("."+settings.search_div_class).slideToggle()}var WIDGET_NAME="ANDS Grant service",WIDGET_ID="_grant_widget_list";$.fn.grant_widget=function(options,param){param="undefined"==typeof param?!1:param;var settings,defaults={search_endpoint:"http://devl.ands.org.au/workareas/liz/ands/registry/services/api/getGrants/?title=",lookup_endpoint:"http://devl.ands.org.au/workareas/liz/ands/registry/services/api/getGrants?id=",pre_lookup:!1,search:!0,pre_open_search:!1,tooltip:!0,info_box_class:"info-box",search_text:'<i class="icon-search"></i> Search',search_class:"grant_search btn btn-default btn-small",lookup:!0,lookup_text:"Look up",lookup_class:"grant_lookup btn btn-default btn-small",before_html:'<span class="grant_before_html">Grant id</span>',wrap_html:'<div class="grant_wrapper"></div>',result_success_class:"grant_success_div",result_error_class:"grant_error_div",search_div_class:"grant_search_div",nohits_msg:"<p>No matches found.</p>",query_text:"Search Query:",search_text_btn:"Search",close_search_text_btn:"[x]",lookup_error_handler:!1,lookup_success_handler:!1,post_lookup_success_handler:!1,auto_close_search:!0,funder_lists:!1,funders:""};if("string"!=typeof options){settings=$.extend({},defaults,options),settings.list_class="undefined"==typeof settings.list_class?"":settings.list_class,settings._wname=WIDGET_NAME,settings._wid=WIDGET_ID;try{return this.each(function(){var $this=$(this);bind_grant_plugin($this,settings)})}catch(err){alert(err)}}},$(".grant_widget").each(function(){{var elem=$(this);elem.grant_widget()}})}(jQuery);